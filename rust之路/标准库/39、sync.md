# std::sync

同步原语

### 无序执行

- 编译器重新排序指令：若编译器可以在较早的时候发出指令，它将尝试如此做：它可能会在代码块的顶部提升内存负载，以便CPU可以开始从内存中预取值。
- 无序执行指令的单处理器：现代CPU能够超标量执行，也就是说，即使机器代码描述的是一个连续的过程，也可能同时执行多条指令。
- 同时执行多个硬件线程的多处理器系统：在多线程情况下，可以使用两种原语来处理同步：
  - memory fences   以确保内存访问以正确的顺序对其他CPU可见
  - atomic operations   以确保对同一内存位置的同时访问不会导致未定义的行为

### 高级同步对象

标准库中的sync对象通常是在操作系统内核的帮助下实现的，内核能够在线程获取锁时重新调度线程。

可用同步对象：

- `Arc`  原子引用计数指针，可以在**多线程环境**中使用它来延长某些数据的生存期，直到所有线程都使用完它为止。
- `Barrier`  **确保多个线程在一起继续执行之前，会等待彼此到达程序中的某个点。**
- `Condvar` 条件变量，提供在**等待事件发生时阻塞线程的能力**。
- `mpsc`  **多生产者，单消费者队列，用于基于消息的通信**。可以提供轻量级的线程间同步机制，但需要一些**额外的内存**。 信道？？
- `Mutex` 互斥机制，确保一次最多有一个线程能够访问某些数据
- `Once`  用于**全局变量的线程安全一次性初始化**。
- `RwLLock`   提供一种互斥机制，该机制允许同时有多个读卡器，而一次只允许一个编写器。在某些情况下，这可能比互斥体更有效。

### Modules

| atomic | 原子类型                           |
| ------ | ---------------------------------- |
| mpsc   | 多生产者，单消费者FIFO队列通信原语 |

### Enums

TryLockError          一种与TryLockResult相关联的可能错误的枚举，这些错误可能在试图从互斥锁上的try_lock方法或RwLock上的try_read和try_write方法获取锁时发生。

### Type Defintions

| LockResult    | 锁方法的类型别名，可能panic  |
| ------------- | ---------------------------- |
| TryLockResult | 非阻塞锁定方法结果的类型别名 |

### structs

| Arc               | 线程安全的引用计数指针。 “ Arc”代表“原子引用计数”。          |
| ----------------- | ------------------------------------------------------------ |
| Barrier           | 屏障使多个线程可以同步某些计算的开始                         |
| BarrierWaitResult | 当Barrier中的所有线程都已集合时，等待返回BarrierWaitResult。 |
| Condvar           | 条件变量                                                     |
| Mutex             | 互斥原语可用于保护共享数据                                   |
| MutexGuard        | 互斥锁的“作用域锁定”的RAII实现。当此结构被丢弃（超出范围）时，锁将被解锁。 |
| Once              | 同步原语，可用于运行一次性全局初始化。对于FFI或相关功能的一次性初始化很有用。此类型只能使用Once :: new构造函数构造。 |
| PoisonError       | 一种错误类型，每当获取锁时都可以返回该错误。                 |
| RwLock            | 读写锁                                                       |
| RwLockReadGuard   | RAII结构用于在删除锁时释放锁的共享读取访问                   |
| RwLockWriteGuard  | RAII结构用于在删除锁时释放锁的排他性写访问。                 |
| WaitTimeoutResult | 指示是否因超时而返回的条件变量的定时等待的类型               |
| Weak              | 弱是Arc的一种版本，其中包含对托管分配的非所有者引用。通过调用弱指针上的升级访问分配，该指针返回Option <Arc <T >>。 |
| OnceState         | 实验：声明为call_once_force的关闭参数的状态。该状态可用于查询一次的panic状态 |

